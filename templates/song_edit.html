{% extends "base.html" %}

{% block title %}{% if is_new %}Nowy utw√≥r{% else %}Edycja: {{ song.song.name }}{% endif %} - Paternologia{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-4">
        <a href="{% if is_new %}/{% else %}/songs/{{ song.song.id }}{% endif %}"
           class="text-indigo-600 hover:text-indigo-800">&larr; Anuluj</a>
        <h1 class="text-2xl font-bold text-gray-800 uppercase">
            {% if is_new %}NOWY UTW√ìR{% else %}EDYCJA: {{ song.song.name }}{% endif %}
        </h1>
    </div>
</div>

<form method="post"
      action="{% if is_new %}/songs{% else %}/songs/{{ song.song.id }}{% endif %}"
      {% if not is_new %}hx-put="/songs/{{ song.song.id }}"{% endif %}
      class="space-y-8">

    <!-- Song Metadata -->
    <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Informacje o utworze</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% if is_new %}
            <div>
                <label for="song_id" class="block text-sm font-medium text-gray-700 mb-1">ID (nazwa pliku)</label>
                <input type="text" name="song_id" id="song_id" required
                       pattern="[a-z0-9-]+"
                       placeholder="np. w-ciszy"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <p class="text-xs text-gray-500 mt-1">Tylko ma≈Çe litery, cyfry i my≈õlniki</p>
            </div>
            {% endif %}
            <div>
                <label for="song_name" class="block text-sm font-medium text-gray-700 mb-1">Nazwa</label>
                <input type="text" name="song_name" id="song_name" required
                       value="{{ song.song.name if song else '' }}"
                       placeholder="np. W ciszy"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="song_author" class="block text-sm font-medium text-gray-700 mb-1">Autor</label>
                <input type="text" name="song_author" id="song_author"
                       value="{{ song.song.author if song else '' }}"
                       placeholder="np. Wojtek"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="md:col-span-2">
                <label for="song_notes" class="block text-sm font-medium text-gray-700 mb-1">Notatki</label>
                <input type="text" name="song_notes" id="song_notes"
                       value="{{ song.song.notes if song else '' }}"
                       placeholder="np. Ballada, tempo 72 BPM"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
        </div>
    </section>

    <!-- Initial Device Settings -->
    <section class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Ustawienia poczƒÖtkowe urzƒÖdze≈Ñ</h2>
        <div class="space-y-4">
            {% for device in devices %}
            {% set settings = song.devices.get(device.id) if song else None %}
            <div class="border border-gray-200 rounded-lg p-4">
                <h3 class="font-medium text-gray-800 mb-3">{{ device.name }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {% if 'preset' in device.action_types | map(attribute='value') | list %}
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Preset</label>
                        <input type="number" name="device_{{ device.id }}_preset"
                               value="{{ settings.preset if settings and settings.preset is not none else '' }}"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Nazwa presetu</label>
                        <input type="text" name="device_{{ device.id }}_preset_name"
                               value="{{ settings.preset_name if settings and settings.preset_name else '' }}"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    {% endif %}
                    {% if 'pattern' in device.action_types | map(attribute='value') | list %}
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Pattern</label>
                        <input type="text" name="device_{{ device.id }}_pattern"
                               value="{{ settings.pattern if settings and settings.pattern else '' }}"
                               placeholder="np. A0"
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- PACER Buttons -->
    <section class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-700">Przyciski PACER</h2>
            <button type="button"
                    id="add-button-btn"
                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                + Dodaj przycisk
            </button>
        </div>

        <div id="pacer-buttons" class="space-y-6">
            {% if song and song.pacer %}
                {% for button in song.pacer %}
                {% set button_idx = loop.index0 %}
                {% include "partials/pacer_button.html" with context %}
                {% endfor %}
            {% endif %}
        </div>
    </section>

    <!-- Submit -->
    <div class="flex justify-end gap-4">
        <a href="{% if is_new %}/{% else %}/songs/{{ song.song.id }}{% endif %}"
           class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
            Anuluj
        </a>
        <button type="submit"
                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            {% if is_new %}Utw√≥rz{% else %}Zapisz{% endif %}
        </button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pacerButtons = document.getElementById('pacer-buttons');
    const addButtonBtn = document.getElementById('add-button-btn');

    function getButtonCount() {
        return pacerButtons.querySelectorAll('.pacer-button-card').length;
    }

    function createButtonCard(buttonIdx) {
        const card = document.createElement('div');
        card.className = 'pacer-button-card border border-gray-200 rounded-lg p-4';
        card.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <span class="bg-indigo-600 text-white px-2 py-1 rounded text-sm font-bold">#${buttonIdx + 1}</span>
                    <input type="text" name="button_${buttonIdx}_name" placeholder="Nazwa przycisku" required
                           class="border border-gray-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-indigo-500">
                </div>
                <button type="button" onclick="this.closest('.pacer-button-card').remove()"
                        class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
            </div>
            <div class="actions-container space-y-2">
            </div>
            <button type="button" onclick="addAction(this, ${buttonIdx})"
                    class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Dodaj akcjƒô</button>
        `;
        return card;
    }

    addButtonBtn.addEventListener('click', function() {
        if (getButtonCount() >= 6) {
            alert('Maksymalnie 6 przycisk√≥w PACER');
            return;
        }
        const buttonIdx = getButtonCount();
        const card = createButtonCard(buttonIdx);
        pacerButtons.appendChild(card);
    });

    window.addAction = function(btn, buttonIdx) {
        const container = btn.previousElementSibling;
        const actionIdx = container.querySelectorAll('.action-row').length;

        if (actionIdx >= 6) {
            alert('Maksymalnie 6 akcji na przycisk');
            return;
        }

        const devices = {{ devices_json | tojson }};
        let deviceOptions = devices.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

        const row = document.createElement('div');
        row.className = 'action-row flex gap-2 items-center flex-wrap';
        row.innerHTML = `
            <select name="button_${buttonIdx}_action_${actionIdx}_device" required
                    class="border border-gray-300 rounded px-2 py-1 text-sm"
                    onchange="updateActionTypes(this, ${buttonIdx}, ${actionIdx})">
                <option value="">UrzƒÖdzenie...</option>
                ${deviceOptions}
            </select>
            <select name="button_${buttonIdx}_action_${actionIdx}_type" required
                    class="border border-gray-300 rounded px-2 py-1 text-sm action-type-select"
                    onchange="updateActionFields(this, ${buttonIdx}, ${actionIdx})">
                <option value="">Typ...</option>
            </select>
            <div class="action-fields flex gap-2"></div>
            <button type="button" onclick="this.closest('.action-row').remove()"
                    class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è</button>
        `;
        container.appendChild(row);
    };

    window.updateActionTypes = function(select, buttonIdx, actionIdx) {
        const devices = {{ devices_json | tojson }};
        const device = devices.find(d => d.id === select.value);
        const typeSelect = select.parentElement.querySelector('.action-type-select');

        typeSelect.innerHTML = '<option value="">Typ...</option>';
        if (device) {
            device.action_types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type === 'preset' ? 'Preset' : type === 'pattern' ? 'Pattern' : 'CC';
                typeSelect.appendChild(option);
            });
        }

        // Clear action fields
        select.parentElement.querySelector('.action-fields').innerHTML = '';
    };

    window.updateActionFields = function(select, buttonIdx, actionIdx) {
        const fieldsContainer = select.parentElement.querySelector('.action-fields');
        const type = select.value;

        let html = '';
        if (type === 'preset') {
            html = `
                <input type="number" name="button_${buttonIdx}_action_${actionIdx}_value" placeholder="Preset #" required
                       class="border border-gray-300 rounded px-2 py-1 text-sm w-20">
                <input type="text" name="button_${buttonIdx}_action_${actionIdx}_label" placeholder="Label"
                       class="border border-gray-300 rounded px-2 py-1 text-sm w-24">
            `;
        } else if (type === 'pattern') {
            html = `
                <input type="text" name="button_${buttonIdx}_action_${actionIdx}_value" placeholder="Pattern" required
                       class="border border-gray-300 rounded px-2 py-1 text-sm w-20">
            `;
        } else if (type === 'cc') {
            html = `
                <input type="number" name="button_${buttonIdx}_action_${actionIdx}_cc" placeholder="CC #" required
                       class="border border-gray-300 rounded px-2 py-1 text-sm w-20">
                <input type="text" name="button_${buttonIdx}_action_${actionIdx}_label" placeholder="Label"
                       class="border border-gray-300 rounded px-2 py-1 text-sm w-24">
            `;
        }
        fieldsContainer.innerHTML = html;
    };
});
</script>
{% endblock %}
